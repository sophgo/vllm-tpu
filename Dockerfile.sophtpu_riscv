# This vLLM Dockerfile is used to construct image that can build and run vLLM on Sophon TPU platform with RISC-V.

# 使用多阶段构建
FROM ubuntu:24.04 AS builder

# set env
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHON_VERSION=3.12 \
    PATH="/root/.local/bin:/root/.cargo/bin:/workspace/.venv/bin:${PATH}" \
    VIRTUAL_ENV=/workspace/.venv

WORKDIR /workspace

# 安装构建依赖
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        ca-certificates \
        curl \
        git \
        python3-dev \
        python3-pip \
        python${PYTHON_VERSION} \
        python${PYTHON_VERSION}-venv \
        ninja-build \
        pkg-config \
        patchelf \
        cmake \
        libprotobuf-dev \
        protobuf-compiler \
        libprotoc-dev \
        libssl-dev \
        llvm-20-dev \
        llvm-20-tools \
        llvm-20 \
        clang \
        numactl \
        libnuma-dev \
        libtcmalloc-minimal4 \
        ffmpeg \
        libsm6 \
        libxext6 \
        libgl1 \
        libjpeg-dev \
        libopenjp2-7-dev \
        libtiff-dev \
        zlib1g-dev \
        libfreetype6-dev \
        liblcms2-dev \
        libwebp-dev \
        gfortran \
        libpng-dev \
        libopenblas-dev \
        liblapack-dev \
        libatlas-base-dev \
        libharfbuzz-dev \
        libfribidi-dev \
        libxcb1-dev && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

ENV LLVM_CONFIG=/usr/lib/llvm-20/bin/llvm-config
ENV PATH="/usr/lib/llvm-20/bin:$PATH"

# install uv and Rust
RUN curl -LsSf https://astral.sh/uv/install.sh | sh && \
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

# create Python virtual environment
RUN uv venv -p python${PYTHON_VERSION} /workspace/.venv && \
    uv pip install pip setuptools

# 安装 torch 和相关依赖
COPY third-party third-party
COPY third-party/ld-linux-riscv* /lib/
RUN cd third-party && \
    uv pip install ./torch-*_riscv64.whl
ENV LD_LIBRARY_PATH=/workspace/.venv/lib/python3.12/site-packages/torch/lib

# 安装 Python 依赖
COPY requirements-common.txt requirements-sophtpu.txt ./
RUN uv pip install -r requirements-sophtpu.txt && \
    uv pip install \
        setuptools_scm aiohttp uvloop fastapi uvicorn partial_json_parser \
        python-multipart pytest setuptools_rust maturin scikit-build meson \
        cython pythran pybind11 scikit-build-core nanobind && \
    rm requirements-*.txt

# 安装 meson-python
RUN git clone --depth 1 https://github.com/mesonbuild/meson-python.git /tmp/meson-python && \
    cd /tmp/meson-python && \
    uv pip install . && \
    rm -rf /tmp/meson-python

RUN git clone --branch v0.23.0 --depth 1 https://github.com/pytorch/vision.git /tmp/vision && \
    cd /tmp/vision && \
    # 设置环境变量
    export FORCE_CUDA=0 && \
    export BUILD_VERSION=0.23.0 && \
    # 关键：设置 PYTHONPATH 让构建系统找到 torch
    export PYTHONPATH=/workspace/.venv/lib/python3.12/site-packages:$PYTHONPATH && \
    # 使用 setup.py 直接安装（绕过 pyproject.toml）
    python setup.py install && \
    cd / && rm -rf /tmp/vision

# 安装 vllm（保持源码在 /workspace/vllm）
RUN git clone --branch v0.11.0 --depth 1 https://github.com/vllm-project/vllm.git /workspace/vllm
WORKDIR /workspace/vllm
RUN python3 use_existing_torch.py && \
    uv pip install -r ./requirements/build.txt && \
    VLLM_TARGET_DEVICE=empty uv pip install -e . --no-build-isolation

# 安装 vllm_sophon（保持源码在 /workspace/vllm_sophon）
WORKDIR /workspace
RUN cd third-party && \
    tar -xzvf torch-tpu*.tar.gz && \
    uv pip install ./dist/torch_tpu*_riscv64.whl && \
    rm -rf third-party
COPY vllm_sophon /workspace/vllm_sophon
WORKDIR /workspace/vllm_sophon
RUN uv pip install -e . --no-build-isolation

# 第二阶段：运行时镜像
FROM ubuntu:24.04

# set env
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHON_VERSION=3.12 \
    PATH="/workspace/.venv/bin:${PATH}" \
    VIRTUAL_ENV=/workspace/.venv

WORKDIR /workspace

# 只安装运行时依赖
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        python3 \
        python${PYTHON_VERSION}-venv \
        numactl \
        libnuma-dev \
        libtcmalloc-minimal4 \
        ffmpeg \
        libsm6 \
        libxext6 \
        libgl1 \
        libjpeg-dev \
        libopenjp2-7-dev \
        libtiff-dev \
        zlib1g-dev \
        libfreetype6-dev \
        liblcms2-dev \
        libwebp-dev \
        libopenblas-dev \
        liblapack-dev \
        libatlas-base-dev \
        libharfbuzz-dev \
        libfribidi-dev \
        libxcb1-dev \
        libprotobuf-dev \
        libssl-dev && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 从构建阶段复制所有必要内容
COPY --from=builder /workspace /workspace
COPY third-party third-party
COPY third-party/ld-linux-riscv* /lib/

# 设置环境变量
ENV LD_LIBRARY_PATH=/workspace/.venv/lib/python3.12/site-packages/torch/lib

# 验证安装
WORKDIR /workspace
RUN python -c "import vllm; print('vLLM imported successfully')" && \
    python -c "import vllm_sophon; print('vLLM Sophon imported successfully')" && \
    python -c "import torch; import torchvision; print(f'PyTorch: {torch.__version__}'); print(f'torchvision: {torchvision.__version__}')"

# 设置默认工作目录
WORKDIR /workspace